<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å·¥ä½œæµå¯¼èˆª</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; box-sizing: border-box;
        }

        /* ğŸ“± æ‰‹æœºç«¯é»˜è®¤æ ·å¼ */
        .main-column { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: var(--bg); 
            position: relative; 
            overflow: hidden; 
        }
        .side-column { 
            display: none; 
            flex: 1; 
            flex-direction: column; 
            background: #fff; 
            overflow: hidden; 
        }
        .app-container.view-notes .main-column { display: none; }
        .app-container.view-notes .side-column { display: flex; }

        /* ğŸ’» ç”µè„‘ç«¯åŒæ å¸ƒå±€ (>= 800px) - 70% vs 30% */
        @media (min-width: 800px) {
            .app-container {
                flex-direction: row;
                padding: 20px;
                gap: 20px;
                max-width: 1400px;
                margin: 0 auto;
            }
            .main-column {
                flex: 7; /* 70% ä»»åŠ¡åŒº */
                background: white;
                border-radius: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                display: flex !important;
            }
            .side-column {
                flex: 3; /* 30% ç¬”è®°åŒº */
                display: flex !important;
                background: white;
                border-radius: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                border-left: 1px solid var(--border);
            }
            #tab-notes-mobile { display: none !important; }
            .btn-close-notes { display: none !important; }
        }

        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        header { padding: 20px 20px 10px 20px; background: var(--card-bg); flex-shrink: 0; z-index: 10; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 16px 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .scroll-content::-webkit-scrollbar { display: none; }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #page-title { font-size: 1.5rem; font-weight: 800; margin: 0; cursor: pointer; border-bottom: 2px solid transparent; color: #111827;}
        #page-title:focus { outline: none; border-bottom-color: var(--primary); background: #eff6ff; }
        
        .datetime-box { text-align: right; }
        .date-line { font-size: 0.85rem; font-weight: 600; color: var(--text-light); }
        .time-line { font-size: 1.1rem; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid transparent; border-radius: 12px; background: #f3f4f6; box-sizing: border-box; font-size: 0.95rem; transition: all 0.2s; }
        .search-input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.1rem;}
        
        .tag-filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .tag-filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 6px 14px; background: white; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap; transition: 0.2s; color: var(--text-light); }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }

        .btn-start { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: white; border: none; padding: 14px; border-radius: 14px; width: 100%; font-weight: 600; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); transition: transform 0.1s; }
        .btn-start:active { transform: scale(0.98); }
        .btn-clear-expired { width: 100%; margin-top: 10px; padding: 10px; background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; border-radius: 10px; font-weight: 600; cursor: pointer; display: none; }
        
        .tab-container { display: flex; background: white; padding: 5px; border-radius: 12px; margin-top: 15px; border: 1px solid var(--border);}
        .tab-item { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; border-radius: 8px; cursor: pointer; color: var(--text-light); font-weight: 500;}
        .tab-item.active { background: #f3f4f6; color: var(--primary); font-weight: 700; }

        /* ä»»åŠ¡å¡ç‰‡ */
        #task-list { list-style: none; padding: 0; margin: 0; }
        .task-card { background: var(--card-bg); padding: 16px 16px 16px 12px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; align-items: center; border: 1px solid transparent; transition: all 0.2s; position: relative; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .task-card.status-error { border-color: var(--danger); background: var(--danger-bg); }
        .task-card.status-success { border-color: var(--success); background: var(--success-bg); }
        .task-card.is-expired { opacity: 0.6; filter: grayscale(1); }
        .task-card.type-cycle { border-left: 4px solid var(--primary); }
        .task-card.type-once { border-left: 4px solid var(--warning); }

        .task-checkbox { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); cursor: pointer; flex-shrink: 0; }
        .task-main { flex: 1; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; }
        .task-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;}
        
        .time-tag { font-weight: 800; color: var(--text); font-size: 1.15rem; font-variant-numeric: tabular-nums;}
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; background: #f3f4f6; color: var(--text-light); font-weight: 500;}
        .tag-pill { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: var(--primary-light); color: var(--primary); font-weight: 600;}
        
        .count-badge { font-size: 0.7rem; font-weight: 700; color: #b45309; background: #fffbeb; padding: 2px 6px; border-radius: 6px; border: 1px solid #fcd34d; display: flex; align-items: center;}
        .status-badge { font-size: 0.75rem; font-weight: 700; display: none; align-items: center; gap: 4px;}
        .status-error .error-mark { display: inline-flex; color: var(--danger); }
        .status-success .success-mark { display: inline-flex; color: var(--success); }

        .task-name { font-weight: 600; font-size: 1.05rem; color: #1f2937; }
        .task-url { font-size: 0.85rem; color: #9ca3af; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        
        .task-actions { display: flex; gap: 8px; margin-left: 10px; align-items: center;}
        .action-btn { background: white; border: 1px solid var(--border); border-radius: 8px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light); transition: all 0.2s; }
        .action-btn:hover { border-color: var(--primary); color: var(--primary); }
        .retry-btn { display: none; background: white; color: var(--danger); border: 1px solid var(--danger); padding: 6px 10px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }
        .retry-btn:hover { background: var(--danger); color: white; }
        .status-error .retry-btn { display: block; }

        .fab { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* ç¬”è®°åŒºåŸŸ */
        .notes-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .notes-title { font-size: 1.2rem; font-weight: 800; color: #b45309; }
        .note-input-box { padding: 15px; background: #fffbeb; border-bottom: 1px solid #fcd34d; }
        #newNoteInput { width: 100%; border: none; background: transparent; font-size: 1rem; resize: none; outline: none; min-height: 60px; font-family: inherit; }
        .btn-add-note { background: #f59e0b; color: white; border: none; padding: 6px 15px; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .notes-list { padding: 15px; overflow-y: auto; flex: 1; }
        .note-card { background: #fff; border: 1px solid #fef3c7; border-left: 4px solid #f59e0b; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .note-card.archived { opacity: 0.6; display: none; }
        .note-meta { display: flex; justify-content: space-between; color: #9ca3af; font-size: 0.75rem; margin-bottom: 6px; }
        .note-content { white-space: pre-wrap; line-height: 1.5; color: #4b5563; outline: none; }
        .note-footer { margin-top: 10px; display: flex; justify-content: flex-end; gap: 8px; opacity: 0.8; }
        .note-btn { font-size: 0.75rem; color: #6b7280; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .note-btn:hover { background: #f3f4f6; color: var(--primary); }
        .archive-toggle { text-align: center; padding: 10px; font-size: 0.85rem; color: var(--text-light); cursor: pointer; border-top: 1px solid var(--border); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal { background: white; width: 90%; max-width: 420px; border-radius: 24px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        .modal h3 { margin: 0 0 20px 0; font-size: 1.25rem; text-align: center; color: #111827; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 700; color: #374151; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; background: var(--input-bg); box-sizing: border-box; transition: all 0.2s; margin-bottom: 20px; }
        .form-input:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px var(--primary-light); }
        .tag-container { border: 1px solid var(--border); border-radius: 12px; padding: 8px; background: var(--input-bg); display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; min-height: 50px; align-items: center; }
        .modal-tag { background: white; border: 1px solid #d1d5db; color: #374151; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; display: flex; align-items: center; gap: 4px;}
        .segmented-control { display: flex; background: #f3f4f6; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .segment-btn { flex: 1; padding: 10px; text-align: center; border-radius: 10px; font-size: 0.9rem; font-weight: 600; color: var(--text-light); cursor: pointer; border: 1px solid transparent; }
        .segment-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-color: #e5e7eb; }
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 20px;}
        .week-btn { aspect-ratio: 1; border: 1px solid var(--border); border-radius: 10px; background: white; font-size: 0.8rem; font-weight: 600; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .week-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .modal-footer { display: flex; gap: 12px; margin-top: 10px; }
        .btn-cancel { flex: 1; padding: 14px; border-radius: 12px; background: #f3f4f6; color: #4b5563; border: none; font-weight: 600; cursor: pointer; }
        .btn-save { flex: 1; padding: 14px; border-radius: 12px; background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 20px; font-size: 0.9rem; z-index: 300; display: none; }
    </style>
</head>
<body>

<div id="toast" class="toast">æç¤º</div>

<div class="app-container" id="appContainer">
    
    <!-- å·¦æ  -->
    <div class="main-column">
        <header>
            <div class="header-top">
                <div><h1 id="page-title" contenteditable="true" spellcheck="false">æˆ‘çš„å·¥ä½œæµ</h1></div>
                <div class="datetime-box">
                    <div class="date-line" id="header-date">--æœˆ--æ—¥</div>
                    <div class="time-line" id="header-time">00:00:00</div>
                </div>
            </div>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ä»»åŠ¡..." oninput="handleSearch()">
            </div>
            <div class="tag-filter-bar" id="tagFilterBar"></div>
            
            <button class="btn-start" onclick="batchOpen()"><span>ğŸš€ ä¸€é”®å¼€å§‹é€‰ä¸­ä»»åŠ¡</span></button>
            <button class="btn-clear-expired" id="btnClearExpired" onclick="clearExpiredTasks()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¿‡æœŸä»»åŠ¡</button>

            <div class="tab-container">
                <div class="tab-item active" onclick="switchView('today')" id="tab-today">ä»Šæ—¥å¾…åŠ</div>
                <div class="tab-item" onclick="switchView('all')" id="tab-all">å…¨éƒ¨ä»»åŠ¡</div>
                <div class="tab-item" onclick="switchView('expired')" id="tab-expired">å·²è¿‡æœŸ</div>
                <div class="tab-item" onclick="switchView('notes')" id="tab-notes-mobile" style="color:#b45309;">éšå¿ƒè®°</div>
            </div>
        </header>

        <div class="scroll-content">
            <ul id="task-list"></ul>
            <div style="height: 60px;"></div>
        </div>
        <div class="fab" id="taskFab" onclick="openModal(null)" title="æ·»åŠ ä»»åŠ¡">+</div>
    </div>

    <!-- å³æ  -->
    <div class="side-column">
        <div class="notes-header">
            <span class="notes-title">ğŸ“ éšå¿ƒç¬”è®°</span>
            <span class="btn-close-notes" style="font-size:0.8rem; color:#999; cursor:pointer;" onclick="switchView('today')">âœ• å…³é—­</span>
        </div>
        <div class="note-input-box">
            <textarea id="newNoteInput" placeholder="å†™ç‚¹ä»€ä¹ˆ... (Ctrl+Enterä¿å­˜)"></textarea>
            <div class="note-tools"><button class="btn-add-note" onclick="addNote()">ä¿å­˜ç¬”è®°</button></div>
        </div>
        <div class="notes-list" id="notesList"></div>
        <div class="archive-toggle" onclick="toggleArchiveView()">
            <span id="archiveToggleText">æ˜¾ç¤ºå·²å½’æ¡£ç¬”è®°</span>
        </div>
    </div>
</div>

<!-- å¼¹çª— -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <h3>æ·»åŠ æ–°é¡µé¢</h3>
        <label class="form-label">åç§°</label>
        <input type="text" id="inName" class="form-input" placeholder="ä¾‹å¦‚ï¼šæœˆåº¦æ±‡æŠ¥">
        <label class="form-label">ç½‘å€</label>
        <input type="text" id="inUrl" class="form-input" placeholder="http://...">
        <label class="form-label">åˆ†ç±»æ ‡ç­¾ (é€‰å¡«)</label>
        <div class="tag-container" onclick="document.getElementById('inTagInput').focus()">
            <div id="modalTagPills" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            <input type="text" id="inTagInput" style="border:none; outline:none; font-size:0.95rem; background:transparent; flex:1; min-width:100px;" placeholder="è¾“å…¥å›è½¦...">
        </div>
        <div id="suggestTagsArea" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:20px;"></div>
        <label class="form-label">å»ºè®®æ—¶é—´</label>
        <input type="time" id="inTime" class="form-input" value="09:30">
        <label class="form-label">é‡å¤ç±»å‹</label>
        <div class="segmented-control">
            <div class="segment-btn active" id="btnCycle" onclick="toggleMode('cycle')">ğŸ“… æ¯å‘¨é‡å¤</div>
            <div class="segment-btn" id="btnOnce" onclick="toggleMode('once')">ğŸ¯ æŒ‡å®šæ—¥æœŸ</div>
        </div>
        <div id="panel-cycle">
            <div class="week-grid">
                <div class="week-btn" data-day="1">ä¸€</div><div class="week-btn" data-day="2">äºŒ</div>
                <div class="week-btn" data-day="3">ä¸‰</div><div class="week-btn" data-day="4">å››</div>
                <div class="week-btn" data-day="5">äº”</div><div class="week-btn" data-day="6">å…­</div>
                <div class="week-btn" data-day="0">æ—¥</div>
            </div>
            <div style="text-align:right; font-size:0.8rem; color:#6b7280; margin-bottom:15px;" id="cycle-text">ä¸é€‰åˆ™é»˜è®¤æ¯å¤©</div>
        </div>
        <div id="panel-once" style="display:none;"><input type="date" id="inDate" class="form-input"></div>
        <div style="display:flex; align-items:center; margin-bottom:20px; cursor:pointer;" onclick="document.getElementById('inAuto').click()">
            <input type="checkbox" id="inAuto" checked style="transform: scale(1.3); margin-right: 10px; accent-color: var(--primary);">
            <span style="font-size:0.95rem; font-weight:500;">åŒ…å«åœ¨ä¸€é”®å¼€å§‹ä¸­ï¼Ÿ</span>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveTask()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. åˆå§‹åŒ–
    // ==========================================
    const defaultData = {
        title: "é»˜è®¤å·¥ä½œæµå¯¼èˆª",
        lastOpenDate: "",
        tasks: [
            { name: "è“é²¸ERP", url: "https://erp.lanjingerp.com", time: "09:30", type: "cycle", days: [], autoOpen: true, tags: ["åŠå…¬"], todayCount: 0 },
            { name: "é¡¹ç›®å¹³å°", url: "https://pmp.lanjingerp.com", time: "09:30", type: "cycle", days: [], autoOpen: true, tags: ["åŠå…¬"], todayCount: 0 },
            { name: "è±†åŒ…", url: "https://www.doubao.com", time: "09:30", type: "cycle", days: [], autoOpen: false, tags: ["AI"], todayCount: 0 }
        ],
        notes: [
            { id: 1700000000001, content: "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼\nå¯ä»¥æŠŠæ¯å¤©å¿…çœ‹çš„ç½‘é¡µï¼ˆERPã€é‚®ç®±ã€æ•°æ®çœ‹æ¿ï¼‰å­˜è¿›å»ï¼Œæ¯å¤©æ—©ä¸Šç‚¹å‡» â€œä¸€é”®å¼€å§‹â€ å°±èƒ½å…¨éƒ¨è‡ªåŠ¨æ‰“å¼€ï¼Œä¸ç”¨ä¸€ä¸ªä¸ªæ‰¾ä¹¦ç­¾äº†ã€‚\næ³¨æ„ï¼šæ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸€é”®æ‰“å¼€æ—¶ï¼Œè¯·ç•™æ„åœ°å€æ æ‹¦æˆªæç¤ºï¼Œé€‰æ‹©**â€œå…è®¸å¼¹çª—â€**ã€‚", createTime: Date.now(), archived: false }
        ]
    };

    let appData = JSON.parse(localStorage.getItem('workflowDataV9_3_Custom')) || defaultData;
    let runtimeStatus = {}; 

    let currentView = 'today';
    let showArchivedNotes = false;
    let editingIndex = null;
    let currentTagFilter = null;
    let tempTags = [];
    let selectedDays = [];
    let currentTaskType = 'cycle';
    let searchQuery = '';
    const daysMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

    function init() {
        const todayStr = new Date().toISOString().split('T')[0];
        if (appData.lastOpenDate !== todayStr) {
            appData.lastOpenDate = todayStr;
            appData.tasks.forEach(t => t.todayCount = 0);
            saveData();
        }

        document.getElementById('page-title').innerText = appData.title;
        
        const updateTime = () => {
            const now = new Date();
            document.getElementById('header-date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${daysMap[now.getDay()]}`;
            document.getElementById('header-time').innerText = now.toLocaleTimeString('en-GB', {hour12:false});
        };
        setInterval(updateTime, 1000);
        updateTime();

        renderTagFilterBar();
        renderList();
        renderNotes();

        document.getElementById('newNoteInput').addEventListener('keydown', (e) => { if(e.ctrlKey && e.key === 'Enter') addNote(); });
        document.getElementById('inTagInput').addEventListener('keydown', (e) => {
            if(e.key==='Enter') { e.preventDefault(); if(e.target.value.trim()) { tempTags.push(e.target.value.trim()); e.target.value = ''; renderModalTags(); } }
        });
        document.getElementById('page-title').addEventListener('blur', (e) => { appData.title = e.target.innerText; saveData(); });
    }

    function renderList() {
        const listEl = document.getElementById('task-list');
        listEl.innerHTML = '';
        const todayStr = new Date(new Date()-new Date().getTimezoneOffset()*60000).toISOString().split('T')[0];
        const dayIdx = new Date().getDay();
        const btnClear = document.getElementById('btnClearExpired');

        let tasks = appData.tasks.map((t, idx) => ({...t, originalIndex: idx})).filter(t => {
            if(searchQuery) return t.name.toLowerCase().includes(searchQuery.toLowerCase()) || t.url.toLowerCase().includes(searchQuery.toLowerCase());
            let isExpired = t.type === 'once' && t.date < todayStr;
            if(currentView === 'expired') return isExpired;
            if(isExpired) return false;
            let isToday = (t.type === 'once' && t.date === todayStr) || (t.type === 'cycle' && (t.days.length===0 || t.days.includes(dayIdx)));
            if(currentView === 'today' && !isToday) return false;
            if(currentTagFilter && (!t.tags || !t.tags.includes(currentTagFilter))) return false;
            return true;
        });

        btnClear.style.display = (currentView === 'expired' && tasks.length > 0) ? 'block' : 'none';
        tasks.sort((a,b) => a.time.localeCompare(b.time));

        if(tasks.length === 0) {
            listEl.innerHTML = '<li style="text-align:center;color:#999;padding:40px;">æš‚æ— ä»»åŠ¡</li>';
            return;
        }

        tasks.forEach((t) => {
            const li = document.createElement('li');
            const status = runtimeStatus[t.originalIndex]; 
            
            let statusClass = '';
            let badgeHtml = '';
            
            if (status === 'success') {
                statusClass = 'status-success';
                badgeHtml = `<span class="status-badge success-mark" style="display:inline-flex">âœ… å·²æ‰“å¼€</span>`;
            } else if (status === 'error') {
                statusClass = 'status-error';
                badgeHtml = `<span class="status-badge error-mark" style="display:inline-flex">âš ï¸ è¢«æ‹¦æˆª</span>`;
            }

            li.className = `task-card type-${t.type} ${statusClass} ${t.isExpired?'is-expired':''}`;
            let tagsHtml = (t.tags||[]).map(tag => `<span class="tag-pill">${tag}</span>`).join(' ');
            const isChecked = t.autoOpen && currentView !== 'expired' ? 'checked' : '';
            const countHtml = (t.todayCount && t.todayCount > 0) ? `<span class="count-badge">ğŸ”¥ ä»Šæ—¥:${t.todayCount}</span>` : '';

            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" value="${t.originalIndex}" ${isChecked}>
                <div class="task-main" onclick="openLink('${t.url}', ${t.originalIndex})">
                    <div class="task-header">
                        <span class="time-tag">${t.time}</span>
                        ${t.autoOpen ? '<span class="badge" style="color:#059669">âš¡</span>' : ''}
                        ${tagsHtml}
                        ${countHtml}
                        ${badgeHtml}
                    </div>
                    <div class="task-name">${t.name}</div>
                    <div class="task-url">${t.url}</div>
                </div>
                <div class="task-actions">
                    <button class="retry-btn" onclick="retryTask('${t.url}', ${t.originalIndex})">â†» é‡è¯•</button>
                    <button class="action-btn" onclick="openModal(${t.originalIndex})">âœ</button>
                    <button class="action-btn" style="color:#ef4444" onclick="deleteTask(${t.originalIndex})">Ã—</button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    function openLink(url, index) {
        const win = window.open(url, '_blank');
        if (win) {
            runtimeStatus[index] = 'success';
            if(appData.tasks[index].todayCount === undefined) appData.tasks[index].todayCount = 0;
            appData.tasks[index].todayCount++;
            saveData();
        } else {
            runtimeStatus[index] = 'error';
        }
        renderList();
    }

    function retryTask(url, index) { openLink(url, index); }

    function batchOpen() {
        const checkboxes = document.querySelectorAll('.task-checkbox:checked');
        if (checkboxes.length === 0) return showToast('è¯·å…ˆå‹¾é€‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡');

        runtimeStatus = {};
        let successCount = 0;
        let failCount = 0;

        checkboxes.forEach(box => {
            const idx = parseInt(box.value);
            const task = appData.tasks[idx];
            const win = window.open(task.url, '_blank');
            if (win) {
                runtimeStatus[idx] = 'success';
                if(task.todayCount === undefined) task.todayCount = 0;
                task.todayCount++;
                successCount++;
            } else {
                runtimeStatus[idx] = 'error';
                failCount++;
            }
        });
        
        saveData(); 
        renderList();

        if (failCount > 0) showToast(`âš ï¸ ${failCount} ä¸ªé¡µé¢è¢«æ‹¦æˆªï¼Œè¯·ç‚¹å‡»â€œé‡è¯•â€`);
        else showToast(`ğŸš€ æˆåŠŸæ‰“å¼€ ${successCount} ä¸ªé¡µé¢`);
    }

    function clearExpiredTasks() {
        const todayStr = new Date(new Date()-new Date().getTimezoneOffset()*60000).toISOString().split('T')[0];
        if(confirm('ç¡®å®šè¦å½»åº•åˆ é™¤æ‰€æœ‰å·²è¿‡æœŸçš„ä»»åŠ¡å—ï¼Ÿ')) {
            appData.tasks = appData.tasks.filter(t => !(t.type === 'once' && t.date < todayStr));
            saveData(); renderList(); showToast('å·²æ¸…ç©ºè¿‡æœŸä»»åŠ¡');
        }
    }

    function saveTask() {
        const name = document.getElementById('inName').value;
        let url = document.getElementById('inUrl').value.trim();
        if(!name || !url) return showToast('ä¿¡æ¯ä¸å…¨');
        if(!url.startsWith('http')) url = 'https://'+url;
        const pendingTag = document.getElementById('inTagInput').value.trim();
        if(pendingTag && !tempTags.includes(pendingTag)) tempTags.push(pendingTag);

        if (editingIndex === null) { 
            const existIndex = appData.tasks.findIndex(t => t.url === url);
            if (existIndex !== -1) {
                if(confirm('æ— éœ€é‡å¤æ·»åŠ ï¼\næ£€æµ‹åˆ°è¯¥é“¾æ¥å·²å­˜åœ¨ï¼Œæ˜¯å¦ç›´æ¥æ‰“å¼€æ—§ä»»åŠ¡è¿›è¡Œç¼–è¾‘ï¼Ÿ')) {
                    closeModal(); setTimeout(() => openModal(existIndex), 300); return;
                }
            }
        }

        const task = {
            name, url, 
            time: document.getElementById('inTime').value,
            autoOpen: document.getElementById('inAuto').checked,
            type: currentTaskType,
            days: [...selectedDays],
            date: document.getElementById('inDate').value,
            tags: [...tempTags],
            todayCount: (editingIndex !== null && appData.tasks[editingIndex].todayCount) || 0
        };

        if(editingIndex===null) appData.tasks.push(task);
        else appData.tasks[editingIndex] = task;
        
        if(editingIndex !== null) delete runtimeStatus[editingIndex];
        saveData(); closeModal(); renderList(); renderTagFilterBar(); showToast('ä¿å­˜æˆåŠŸ');
    }

    function switchView(view) {
        currentView = view;
        const app = document.getElementById('appContainer');
        const fab = document.getElementById('taskFab');
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        if(document.getElementById(`tab-${view}`)) document.getElementById(`tab-${view}`).classList.add('active');
        if(view === 'notes') { app.classList.add('view-notes'); fab.style.display = 'none'; }
        else { app.classList.remove('view-notes'); fab.style.display = 'flex'; renderList(); }
    }
    function renderTagFilterBar() {
        const bar = document.getElementById('tagFilterBar');
        const allTags = new Set();
        appData.tasks.forEach(t => (t.tags||[]).forEach(tag => allTags.add(tag)));
        let html = `<span class="filter-chip ${!currentTagFilter?'active':''}" onclick="currentTagFilter=null;renderTagFilterBar();renderList()">å…¨éƒ¨</span>`;
        allTags.forEach(tag => { html += `<span class="filter-chip ${currentTagFilter===tag?'active':''}" onclick="currentTagFilter='${tag}';renderTagFilterBar();renderList()">${tag}</span>`; });
        bar.innerHTML = html;
    }
    function openModal(index) {
        editingIndex = index;
        document.getElementById('modal').classList.add('open');
        const t = index !== null ? appData.tasks[index] : {name:'', url:'', time:'09:30', autoOpen:true, type:'cycle', days:[], tags:[]};
        document.getElementById('inName').value = t.name; document.getElementById('inUrl').value = t.url;
        document.getElementById('inTime').value = t.time; document.getElementById('inAuto').checked = t.autoOpen;
        tempTags = t.tags ? [...t.tags] : []; selectedDays = t.days ? [...t.days] : []; currentTaskType = t.type;
        if(t.type==='once') { document.getElementById('inDate').value = t.date || new Date().toISOString().split('T')[0]; toggleMode('once'); } else { toggleMode('cycle'); }
        renderModalTags(); updateWeekBtns();
    }
    function toggleMode(mode) {
        currentTaskType = mode;
        document.getElementById('panel-cycle').style.display = mode==='cycle'?'block':'none';
        document.getElementById('panel-once').style.display = mode==='once'?'block':'none';
        const btnCycle = document.getElementById('btnCycle'); const btnOnce = document.getElementById('btnOnce');
        if(mode === 'cycle') { btnCycle.classList.add('active'); btnOnce.classList.remove('active'); } 
        else { btnOnce.classList.add('active'); btnCycle.classList.remove('active'); }
    }
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.addEventListener('click', function() { const d = parseInt(this.dataset.day); const i = selectedDays.indexOf(d); if(i>-1) selectedDays.splice(i,1); else selectedDays.push(d); updateWeekBtns(); });
    });
    function updateWeekBtns() {
        document.querySelectorAll('.week-btn').forEach(btn => { const day = parseInt(btn.dataset.day); if(selectedDays.includes(day)) btn.classList.add('selected'); else btn.classList.remove('selected'); });
        document.getElementById('cycle-text').innerText = selectedDays.length === 0 ? 'ä¸é€‰åˆ™é»˜è®¤æ¯å¤©' : 'ä»…åœ¨é€‰ä¸­æ—¥æœŸæ˜¾ç¤º';
    }
    function renderModalTags() {
        document.getElementById('modalTagPills').innerHTML = tempTags.map(t => `<span class="modal-tag" onclick="removeTempTag('${t}')">${t} <span>Ã—</span></span>`).join('');
        const suggestArea = document.getElementById('suggestTagsArea');
        const allTags = new Set(["åˆ†æç±»", "æå‡å®¡ç¾", "åŠå…¬", "å·¥å…·"]);
        appData.tasks.forEach(t => (t.tags||[]).forEach(tag => allTags.add(tag)));
        let suggestHtml = ''; allTags.forEach(tag => { if(!tempTags.includes(tag)) suggestHtml += `<span class="badge" style="cursor:pointer; border:1px solid #e5e7eb; padding:4px 8px;" onclick="addTempTag('${tag}')">+ ${tag}</span>` });
        suggestArea.innerHTML = suggestHtml;
    }
    function addTempTag(tag) { if(!tempTags.includes(tag)) { tempTags.push(tag); renderModalTags(); } }
    function removeTempTag(tag) { tempTags = tempTags.filter(t => t !== tag); renderModalTags(); }
    function deleteTask(idx) { if(confirm('åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) { appData.tasks.splice(idx,1); saveData(); renderList(); renderTagFilterBar(); } }
    function closeModal() { document.getElementById('modal').classList.remove('open'); }
    function saveData() { localStorage.setItem('workflowDataV9_3_Custom', JSON.stringify(appData)); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
    function handleSearch() { searchQuery = document.getElementById('searchInput').value; renderList(); }

    function renderNotes() {
        const list = document.getElementById('notesList'); list.innerHTML = '';
        const notes = appData.notes.sort((a,b) => b.createTime - a.createTime);
        notes.forEach(note => {
            if(note.archived && !showArchivedNotes) return;
            const div = document.createElement('div'); div.className = `note-card ${note.archived ? 'archived' : ''}`; if(showArchivedNotes && note.archived) div.style.display = 'block';
            div.innerHTML = `<div class="note-meta"><span>${new Date(note.createTime).toLocaleString()}</span><span>${note.archived ? 'å·²å½’æ¡£' : ''}</span></div><div class="note-content" contenteditable="true" onblur="updateNoteContent(${note.id}, this)">${note.content}</div><div class="note-footer"><span class="note-btn" onclick="toggleArchiveNote(${note.id})">${note.archived ? 'è¿˜åŸ' : 'å½’æ¡£'}</span><span class="note-btn del" onclick="deleteNote(${note.id})">åˆ é™¤</span></div>`;
            list.appendChild(div);
        });
    }
    function addNote() { const v = document.getElementById('newNoteInput').value.trim(); if(v){ appData.notes.unshift({ id: Date.now(), content: v, createTime: Date.now(), archived: false }); document.getElementById('newNoteInput').value=''; saveData(); renderNotes(); showToast('ç¬”è®°å·²ä¿å­˜'); } }
    function updateNoteContent(id, el) { const n = appData.notes.find(n => n.id === id); if(n) { n.content = el.innerText; saveData(); } }
    function toggleArchiveNote(id) { const n = appData.notes.find(n => n.id === id); if(n) { n.archived = !n.archived; saveData(); renderNotes(); } }
    function deleteNote(id) { if(confirm('åˆ é™¤æ­¤ç¬”è®°ï¼Ÿ')) { appData.notes = appData.notes.filter(n => n.id !== id); saveData(); renderNotes(); } }
    function toggleArchiveView() { showArchivedNotes = !showArchivedNotes; document.getElementById('archiveToggleText').innerText = showArchivedNotes ? 'éšè—å·²å½’æ¡£ç¬”è®°' : 'æ˜¾ç¤ºå·²å½’æ¡£ç¬”è®°'; renderNotes(); }

    init();
</script>
</body>
</html>
