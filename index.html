<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„å·¥ä½œæµå¯¼èˆª</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #334155;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --tag-bg: #e0e7ff;
            --tag-text: #4338ca;
            --note-bg: #fffbeb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* ğŸ“± æ‰‹æœºç«¯æ ·å¼ */
        .main-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }
        .side-column {
            display: none;
            flex: 1;
            flex-direction: column;
            background: #fff;
            overflow: hidden;
        }
        .app-container.view-notes .main-column { display: none; }
        .app-container.view-notes .side-column { display: flex; }

        /* ğŸ’» ç”µè„‘ç«¯åŒæ å¸ƒå±€ (>= 800px) */
        @media (min-width: 800px) {
            .app-container {
                flex-direction: row;
                padding: 20px;
                gap: 20px;
                max-width: 1400px;
                margin: 0 auto;
            }
            .main-column {
                flex: 7; /* 70% ä»»åŠ¡åŒº */
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
                display: flex !important;
            }
            .side-column {
                flex: 3; /* 30% ç¬”è®°åŒº */
                display: flex !important;
                background: white;
                border-radius: 16px;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
                border-left: 1px solid var(--border);
            }
            #tab-notes-mobile { display: none !important; }
            .btn-close-notes { display: none !important; }
        }

        /* --- å·¦ä¾§æ ·å¼ --- */
        header {
            padding: 20px 20px 10px 20px;
            background: var(--card-bg);
            flex-shrink: 0;
            z-index: 10;
        }
        
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .scroll-content::-webkit-scrollbar { display: none; }

        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        #page-title { font-size: 1.4rem; font-weight: 800; margin: 0; cursor: pointer; border-bottom: 2px solid transparent;}
        #page-title:focus { outline: none; border-bottom-color: var(--primary); background: #eff6ff; }
        .datetime-box { text-align: right; }
        .date-line { font-size: 0.9rem; font-weight: 600; }
        .time-line { font-size: 1.1rem; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; }

        .search-box { position: relative; margin-bottom: 10px; }
        .search-input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid var(--border); border-radius: 10px; background: #f1f5f9; box-sizing: border-box; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        
        .tag-filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scrollbar-width: none; }
        .tag-filter-bar::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 6px 14px; background: #f1f5f9; border-radius: 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: 0.2s;}
        .filter-chip.active { background: var(--tag-text); color: white; }

        .btn-start { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; }
        
        .tab-container { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-top: 15px; }
        .tab-item { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; border-radius: 8px; cursor: pointer; color: var(--text-light); }
        .tab-item.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        #task-list { list-style: none; padding: 0; margin: 0; }
        .task-card { background: var(--card-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid transparent; }
        .task-card.type-cycle { border-left-color: var(--primary); }
        .task-card.type-once { border-left-color: var(--warning); }
        .task-card.is-expired { opacity: 0.7; border-left-color: #ccc;}
        .task-card.status-error { border: 2px solid var(--danger); background: #fef2f2; }
        .task-card.status-success { border: 1px solid var(--success); background: #f0fdf4; }

        .task-content { flex: 1; overflow: hidden; cursor: pointer; }
        .task-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;}
        .time-tag { font-weight: 700; color: var(--text); font-size: 1.1rem; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: var(--text-light); }
        .tag-pill { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: var(--tag-bg); color: var(--tag-text); }
        .task-name { font-weight: 600; }
        .task-url { font-size: 0.8rem; color: var(--text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        
        .task-actions { display: flex; gap: 8px; margin-left: 10px; }
        .action-btn { background: transparent; border: 1px solid var(--border); border-radius: 6px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-light); }
        .retry-btn { display: none; background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .status-error .retry-btn { display: block; }

        /* FAB */
        .fab { 
            position: absolute; bottom: 30px; right: 30px; 
            width: 56px; height: 56px; background: var(--primary); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 26px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); 
            cursor: pointer; z-index: 100; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.05); }

        /* --- å³ä¾§æ ·å¼ --- */
        .notes-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .notes-title { font-size: 1.2rem; font-weight: 800; color: #b45309; }
        .note-input-box { padding: 15px; background: #fffbeb; border-bottom: 1px solid #fcd34d; }
        #newNoteInput { width: 100%; border: none; background: transparent; font-size: 1rem; resize: none; outline: none; min-height: 60px; font-family: inherit; }
        .note-tools { display: flex; justify-content: flex-end; margin-top: 5px; }
        .btn-add-note { background: #f59e0b; color: white; border: none; padding: 6px 15px; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }

        .notes-list { padding: 15px; overflow-y: auto; flex: 1; }
        .note-card { background: #fff; border: 1px solid #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s; }
        .note-card.archived { opacity: 0.6; background: #f9fafb; border-color: #e5e7eb; display: none; }
        .note-card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .note-meta { display: flex; justify-content: space-between; color: #9ca3af; font-size: 0.75rem; margin-bottom: 6px; }
        .note-content { white-space: pre-wrap; line-height: 1.5; color: #4b5563; outline: none; cursor: text; }
        .note-content:focus { background: #fffbeb; padding: 2px; border-radius: 4px; }
        .note-footer { margin-top: 10px; display: flex; justify-content: flex-end; gap: 8px; opacity: 0; transition: opacity 0.2s; }
        .note-card:hover .note-footer { opacity: 1; }
        .note-btn { font-size: 0.75rem; color: #6b7280; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .note-btn:hover { background: #f3f4f6; color: var(--primary); }
        .note-btn.del:hover { color: var(--danger); }
        .archive-toggle { text-align: center; padding: 10px; font-size: 0.85rem; color: var(--text-light); cursor: pointer; border-top: 1px solid var(--border); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 85%; max-width: 400px; border-radius: 16px; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; box-sizing: border-box;}
        .tag-input-area { border: 1px solid var(--border); border-radius: 8px; padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;}
        .modal-tag { background: var(--tag-bg); color: var(--tag-text); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;}
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 20px; font-size: 0.9rem; z-index: 300; display: none; }
    </style>
</head>
<body>

<div id="toast" class="toast">æç¤º</div>

<div class="app-container" id="appContainer">
    
    <!-- å·¦æ ï¼šå·¥ä½œæµ (70%) -->
    <div class="main-column">
        <header>
            <div class="header-top">
                <div><h1 id="page-title" contenteditable="true" spellcheck="false">æˆ‘çš„å·¥ä½œæµ</h1></div>
                <div class="datetime-box">
                    <div class="date-line" id="header-date">--æœˆ--æ—¥</div>
                    <div class="time-line" id="header-time">00:00:00</div>
                </div>
            </div>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢ä»»åŠ¡..." oninput="handleSearch()">
            </div>
            <div class="tag-filter-bar" id="tagFilterBar"></div>
            <button class="btn-start" onclick="batchOpen()"><span>ğŸš€ ä¸€é”®å¼€å§‹ä»Šæ—¥å·¥ä½œ</span></button>
            <div class="tab-container">
                <div class="tab-item active" onclick="switchView('today')" id="tab-today">ä»Šæ—¥å¾…åŠ</div>
                <div class="tab-item" onclick="switchView('all')" id="tab-all">å…¨éƒ¨ä»»åŠ¡</div>
                <div class="tab-item" onclick="switchView('expired')" id="tab-expired">ğŸ—‘ï¸ å·²è¿‡æœŸ</div>
                <div class="tab-item" onclick="switchView('notes')" id="tab-notes-mobile" style="color:#b45309;">ğŸ“ éšå¿ƒè®°</div>
            </div>
        </header>

        <div class="scroll-content">
            <ul id="task-list"></ul>
            <div style="height: 60px;"></div>
        </div>
        <!-- FABä½äºä»»åŠ¡åŒºå†… -->
        <div class="fab" id="taskFab" onclick="openModal(null)" title="æ·»åŠ ä»»åŠ¡">+</div>
    </div>

    <!-- å³æ ï¼šç¬”è®° (30%) -->
    <div class="side-column">
        <div class="notes-header">
            <span class="notes-title">ğŸ“ éšå¿ƒç¬”è®°</span>
            <span class="btn-close-notes" style="font-size:0.8rem; color:#999; cursor:pointer;" onclick="switchView('today')">âœ• å…³é—­</span>
        </div>
        <div class="note-input-box">
            <textarea id="newNoteInput" placeholder="å†™ç‚¹ä»€ä¹ˆ... (Ctrl+Enterä¿å­˜)"></textarea>
            <div class="note-tools"><button class="btn-add-note" onclick="addNote()">ä¿å­˜ç¬”è®°</button></div>
        </div>
        <div class="notes-list" id="notesList"></div>
        <div class="archive-toggle" onclick="toggleArchiveView()">
            <span id="archiveToggleText">æ˜¾ç¤ºå·²å½’æ¡£ç¬”è®°</span>
        </div>
    </div>
</div>

<!-- å¼¹çª—éƒ¨åˆ† -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <h3 style="margin-top:0">ä»»åŠ¡ç®¡ç†</h3>
        <input type="text" id="inName" class="form-control" placeholder="åç§° (å¦‚: ç™¾åº¦)">
        <input type="text" id="inUrl" class="form-control" placeholder="ç½‘å€ (å¦‚: baidu.com)">
        <label style="font-size:0.9rem; font-weight:600; display:block; margin-bottom:5px;">æ ‡ç­¾</label>
        <div class="tag-input-area" onclick="document.getElementById('inTagInput').focus()">
            <div id="modalTagPills" style="display:inline;"></div>
            <input type="text" id="inTagInput" style="border:none; outline:none; font-size:0.9rem;" placeholder="è¾“å…¥å›è½¦...">
        </div>
        <input type="time" id="inTime" class="form-control" value="09:30" style="margin-top:10px;">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="form-control" onclick="toggleMode('cycle')" id="btnCycle">æ¯å‘¨é‡å¤</button>
            <button class="form-control" onclick="toggleMode('once')" id="btnOnce">æŒ‡å®šæ—¥æœŸ</button>
        </div>
        <div id="panel-cycle">
            <div style="display:flex; gap:2px;">
                <button class="week-btn" data-day="1">ä¸€</button><button class="week-btn" data-day="2">äºŒ</button>
                <button class="week-btn" data-day="3">ä¸‰</button><button class="week-btn" data-day="4">å››</button>
                <button class="week-btn" data-day="5">äº”</button><button class="week-btn" data-day="6">å…­</button>
                <button class="week-btn" data-day="0">æ—¥</button>
            </div>
        </div>
        <div id="panel-once" style="display:none;"><input type="date" id="inDate" class="form-control"></div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button class="form-control" style="background:#f3f4f6; border:none;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="form-control" style="background:var(--primary); color:white; border:none;" onclick="saveTask()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. åˆå§‹åŒ–ä¸é»˜è®¤æ•°æ® (å…³é”®ä¿®æ”¹)
    // ==========================================
    const defaultData = {
        title: "é»˜è®¤å·¥ä½œæµå¯¼èˆª",
        tasks: [
            {
                name: "ç™¾åº¦æœç´¢",
                url: "https://www.baidu.com",
                time: "09:00",
                type: "cycle",
                days: [], // æ¯å¤©
                autoOpen: true,
                tags: ["æœç´¢", "å¸¸ç”¨"],
                status: ""
            },
            {
                name: "å…¬å¸é‚®ç®± (ç¤ºä¾‹)",
                url: "https://mail.qq.com",
                time: "09:30",
                type: "cycle",
                days: [],
                autoOpen: true,
                tags: ["åŠå…¬"],
                status: ""
            },
            {
                name: "AI åŠ©æ‰‹ (ChatGPT)",
                url: "https://chat.openai.com",
                time: "10:00",
                type: "cycle",
                days: [],
                autoOpen: false,
                tags: ["å·¥å…·", "AI"],
                status: ""
            },
            {
                name: "å‘¨äº”å·¥ä½œæ±‡æŠ¥",
                url: "https://docs.qq.com/",
                time: "17:30",
                type: "cycle",
                days: [5], // å‘¨äº”
                autoOpen: false,
                tags: ["æ±‡æŠ¥"],
                status: ""
            }
        ],
        notes: [
            {
                id: 1700000000001,
                content: "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼\n\n1. å·¦ä¾§æ˜¯ä»»åŠ¡åŒºï¼Œå³ä¾§æ˜¯ç¬”è®°åŒº (7:3 æ¯”ä¾‹)ã€‚\n2. ç‚¹å‡»ä»»åŠ¡å³ä¾§çš„ âœ å¯ä¿®æ”¹ï¼ŒÃ— å¯åˆ é™¤ã€‚\n3. æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚",
                createTime: Date.now(),
                archived: false
            }
        ]
    };

    // ä½¿ç”¨ V8_Deploy ä½œä¸ºKeyï¼Œç¡®ä¿æ–°ç”¨æˆ·èƒ½åŠ è½½åˆ°ä¸Šé¢çš„é»˜è®¤æ•°æ®
    let appData = JSON.parse(localStorage.getItem('workflowDataV8_Deploy')) || defaultData;

    let currentView = 'today';
    let showArchivedNotes = false;
    let editingIndex = null;
    let currentTagFilter = null;
    let tempTags = [];
    let selectedDays = [];
    let currentTaskType = 'cycle';
    let searchQuery = '';
    const daysMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

    function init() {
        document.getElementById('page-title').innerText = appData.title;
        setInterval(() => {
            const now = new Date();
            document.getElementById('header-date').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${daysMap[now.getDay()]}`;
            document.getElementById('header-time').innerText = now.toLocaleTimeString('en-GB', {hour12:false});
        }, 1000);

        renderTagFilterBar();
        renderList();
        renderNotes();

        // äº‹ä»¶ç»‘å®š
        document.getElementById('newNoteInput').addEventListener('keydown', (e) => {
            if(e.ctrlKey && e.key === 'Enter') addNote();
        });
        document.getElementById('inTagInput').addEventListener('keydown', (e) => {
            if(e.key==='Enter') {
                e.preventDefault();
                if(e.target.value.trim()) {
                    tempTags.push(e.target.value.trim());
                    e.target.value = '';
                    renderModalTags();
                }
            }
        });
        document.getElementById('page-title').addEventListener('blur', (e) => {
            appData.title = e.target.innerText; saveData();
        });
    }

    function switchView(view) {
        currentView = view;
        const app = document.getElementById('appContainer');
        const fab = document.getElementById('taskFab');
        
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        if(document.getElementById(`tab-${view}`)) {
            document.getElementById(`tab-${view}`).classList.add('active');
        }

        if(view === 'notes') {
            app.classList.add('view-notes');
            fab.style.display = 'none';
        } else {
            app.classList.remove('view-notes');
            fab.style.display = 'flex';
            renderList();
        }
    }

    // ==========================================
    // 2. ç¬”è®°é€»è¾‘
    // ==========================================
    function renderNotes() {
        const list = document.getElementById('notesList');
        list.innerHTML = '';
        const notes = appData.notes.sort((a,b) => b.createTime - a.createTime);

        notes.forEach(note => {
            if(note.archived && !showArchivedNotes) return;
            const div = document.createElement('div');
            div.className = `note-card ${note.archived ? 'archived' : ''}`;
            if(showArchivedNotes && note.archived) div.style.display = 'block';
            const dateStr = new Date(note.createTime).toLocaleString();

            div.innerHTML = `
                <div class="note-meta">
                    <span>${dateStr}</span>
                    <span>${note.archived ? 'å·²å½’æ¡£' : ''}</span>
                </div>
                <div class="note-content" contenteditable="true" onblur="updateNoteContent(${note.id}, this)">${note.content}</div>
                <div class="note-footer">
                    <span class="note-btn" onclick="toggleArchiveNote(${note.id})">${note.archived ? 'è¿˜åŸ' : 'å½’æ¡£'}</span>
                    <span class="note-btn del" onclick="deleteNote(${note.id})">åˆ é™¤</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function addNote() {
        const input = document.getElementById('newNoteInput');
        const content = input.value.trim();
        if(!content) return;
        appData.notes.unshift({ id: Date.now(), content: content, createTime: Date.now(), archived: false });
        input.value = '';
        saveData(); renderNotes(); showToast('ç¬”è®°å·²æ·»åŠ ');
    }
    function updateNoteContent(id, el) {
        const note = appData.notes.find(n => n.id === id);
        if(note) { note.content = el.innerText; saveData(); }
    }
    function toggleArchiveNote(id) {
        const note = appData.notes.find(n => n.id === id);
        if(note) { note.archived = !note.archived; saveData(); renderNotes(); }
    }
    function deleteNote(id) {
        if(confirm('åˆ é™¤è¿™æ¡ç¬”è®°ï¼Ÿ')) { appData.notes = appData.notes.filter(n => n.id !== id); saveData(); renderNotes(); }
    }
    function toggleArchiveView() {
        showArchivedNotes = !showArchivedNotes;
        document.getElementById('archiveToggleText').innerText = showArchivedNotes ? 'éšè—å·²å½’æ¡£ç¬”è®°' : 'æ˜¾ç¤ºå·²å½’æ¡£ç¬”è®°';
        renderNotes();
    }

    // ==========================================
    // 3. ä»»åŠ¡åˆ—è¡¨é€»è¾‘
    // ==========================================
    function renderList() {
        const listEl = document.getElementById('task-list');
        listEl.innerHTML = '';
        const todayStr = new Date(new Date()-new Date().getTimezoneOffset()*60000).toISOString().split('T')[0];
        const dayIdx = new Date().getDay();

        let tasks = appData.tasks.filter(t => {
            if(searchQuery) return t.name.toLowerCase().includes(searchQuery.toLowerCase()) || t.url.toLowerCase().includes(searchQuery.toLowerCase());
            let isExpired = t.type === 'once' && t.date < todayStr;
            if(currentView === 'expired') return isExpired;
            if(isExpired) return false;
            let isToday = (t.type === 'once' && t.date === todayStr) || (t.type === 'cycle' && (t.days.length===0 || t.days.includes(dayIdx)));
            if(currentView === 'today' && !isToday) return false;
            if(currentTagFilter && (!t.tags || !t.tags.includes(currentTagFilter))) return false;
            return true;
        });
        
        tasks.sort((a,b) => a.time.localeCompare(b.time));

        if(tasks.length === 0) {
            listEl.innerHTML = '<li style="text-align:center;color:#999;padding:40px;">æš‚æ— ä»»åŠ¡</li>';
            return;
        }

        tasks.forEach((t, idx) => {
            const li = document.createElement('li');
            li.className = `task-card type-${t.type}`;
            let tagsHtml = (t.tags||[]).map(tag => `<span class="tag-pill">${tag}</span>`).join(' ');
            
            li.innerHTML = `
                <div class="task-content" onclick="window.open('${t.url}')">
                    <div class="task-header">
                        <span class="time-tag">${t.time}</span>
                        ${t.autoOpen ? '<span class="badge" style="color:#059669">âš¡</span>' : ''}
                        ${tagsHtml}
                    </div>
                    <div class="task-name">${t.name}</div>
                </div>
                <div class="task-actions">
                    <button class="action-btn" onclick="openModal(${appData.tasks.indexOf(t)})">âœ</button>
                    <button class="action-btn" style="color:#ef4444" onclick="deleteTask(${appData.tasks.indexOf(t)})">Ã—</button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    function renderTagFilterBar() {
        const bar = document.getElementById('tagFilterBar');
        const allTags = new Set();
        appData.tasks.forEach(t => (t.tags||[]).forEach(tag => allTags.add(tag)));
        let html = `<span class="filter-chip ${!currentTagFilter?'active':''}" onclick="currentTagFilter=null;renderTagFilterBar();renderList()">å…¨éƒ¨</span>`;
        allTags.forEach(tag => {
            html += `<span class="filter-chip ${currentTagFilter===tag?'active':''}" onclick="currentTagFilter='${tag}';renderTagFilterBar();renderList()">${tag}</span>`;
        });
        bar.innerHTML = html;
    }

    function openModal(index) {
        editingIndex = index;
        document.getElementById('modal').classList.add('open');
        const t = index !== null ? appData.tasks[index] : {name:'', url:'', time:'09:30', autoOpen:true, type:'cycle', days:[], tags:[]};
        
        document.getElementById('inName').value = t.name;
        document.getElementById('inUrl').value = t.url;
        document.getElementById('inTime').value = t.time;
        tempTags = t.tags ? [...t.tags] : [];
        selectedDays = t.days ? [...t.days] : [];
        currentTaskType = t.type;
        
        if(t.type==='once') {
             document.getElementById('inDate').value = t.date || new Date().toISOString().split('T')[0];
             toggleMode('once');
        } else {
            toggleMode('cycle');
        }
        renderModalTags();
        updateWeekBtns();
    }

    function toggleMode(mode) {
        currentTaskType = mode;
        document.getElementById('panel-cycle').style.display = mode==='cycle'?'block':'none';
        document.getElementById('panel-once').style.display = mode==='once'?'block':'none';
        document.getElementById('btnCycle').style.background = mode==='cycle'?'#e0e7ff':'#f3f4f6';
        document.getElementById('btnOnce').style.background = mode==='once'?'#e0e7ff':'#f3f4f6';
    }
    
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const d = parseInt(this.dataset.day);
            const i = selectedDays.indexOf(d);
            if(i>-1) selectedDays.splice(i,1); else selectedDays.push(d);
            updateWeekBtns();
        });
    });
    function updateWeekBtns() {
        document.querySelectorAll('.week-btn').forEach(btn => {
            btn.style.background = selectedDays.includes(parseInt(btn.dataset.day)) ? 'var(--primary)' : 'white';
            btn.style.color = selectedDays.includes(parseInt(btn.dataset.day)) ? 'white' : '#333';
        });
    }

    function renderModalTags() {
        document.getElementById('modalTagPills').innerHTML = tempTags.map(t => 
            `<span class="modal-tag" onclick="tempTags=tempTags.filter(x=>x!=='${t}');renderModalTags()"> ${t} Ã—</span>`
        ).join(' ');
    }

    function saveTask() {
        const name = document.getElementById('inName').value;
        let url = document.getElementById('inUrl').value;
        if(!name || !url) return showToast('ä¿¡æ¯ä¸å…¨');
        if(!url.startsWith('http')) url = 'https://'+url;

        const task = {
            name, url, 
            time: document.getElementById('inTime').value,
            autoOpen: true,
            type: currentTaskType,
            days: [...selectedDays],
            date: document.getElementById('inDate').value,
            tags: [...tempTags]
        };

        if(editingIndex===null) appData.tasks.push(task);
        else appData.tasks[editingIndex] = task;
        
        saveData(); closeModal(); renderList(); renderTagFilterBar();
    }

    function deleteTask(idx) {
        if(confirm('åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ')) { appData.tasks.splice(idx,1); saveData(); renderList(); renderTagFilterBar(); }
    }
    
    function closeModal() { document.getElementById('modal').classList.remove('open'); }
    function saveData() { localStorage.setItem('workflowDataV8_Deploy', JSON.stringify(appData)); }
    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block';
        setTimeout(()=>t.style.display='none', 2000);
    }
    function handleSearch() { searchQuery = document.getElementById('searchInput').value; renderList(); }
    function batchOpen() {
        const todayStr = new Date(new Date()-new Date().getTimezoneOffset()*60000).toISOString().split('T')[0];
        const dayIdx = new Date().getDay();
        let count = 0;
        appData.tasks.forEach(t => {
            if(!t.autoOpen) return;
            let run = (t.type==='once' && t.date===todayStr) || (t.type==='cycle' && (t.days.length===0 || t.days.includes(dayIdx)));
            if(run) { window.open(t.url); count++; }
        });
        showToast(count>0 ? `å·²æ‰“å¼€${count}ä¸ª` : 'æ— ä»»åŠ¡');
    }

    init();
</script>
</body>
</html>